import streamlit as st
from scraper import Scraper
from database import Database
import pandas as pd
from config import PRODUCT_CODES, SIZES
import logging
import os
from datetime import datetime
import time

# ãƒ­ã‚°ã®è¨­å®š
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('data/logs/app.log', mode='a', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

# Streamlitã®è¨­å®š
st.set_page_config(
    page_title="æ®µãƒœãƒ¼ãƒ«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ—ãƒª",
    page_icon="ğŸ“¦",
    layout="wide"
)

# ã‚¿ã‚¤ãƒˆãƒ«
st.title("æ®µãƒœãƒ¼ãƒ«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ—ãƒª")

# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã®åˆæœŸåŒ–
@st.cache_resource
def init_scraper():
    return Scraper()

scraper = init_scraper()

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–
db = Database()
    
# ã‚µã‚¤ã‚ºé¸æŠ
st.header("ã‚µã‚¤ã‚ºé¸æŠ")
selected_size = st.selectbox(
    "å–å¾—ã—ãŸã„ã‚µã‚¤ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„",
    SIZES,
    index=0
)

if not selected_size:
    st.warning("ã‚µã‚¤ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
else:
    if st.button("é¸æŠã—ãŸã‚µã‚¤ã‚ºã®å•†å“IDã‚’å–å¾—"):
        with st.spinner("å•†å“IDã‚’å–å¾—ä¸­..."):
            try:
                product_ids = scraper.get_product_ids([selected_size])
                if product_ids:
                    st.success(f"{len(product_ids)}ä»¶ã®å•†å“IDã‚’å–å¾—ã—ã¾ã—ãŸã€‚")
                    
                    # å•†å“IDã®è¡¨ç¤º
                    st.subheader("å–å¾—ã—ãŸå•†å“ID")
                    df = pd.DataFrame([
                        {"å•†å“ID": p['id'], "å•†å“å": p['name'], "ã‚µã‚¤ã‚º": selected_size}
                        for p in product_ids
                    ])
                    st.dataframe(df)
                    
                    # ã‚µã‚¤ã‚ºã”ã¨ã®çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³
                    if st.button(f"{selected_size}ã®å•†å“ã‚’çµã‚Šè¾¼ã‚€"):
                        filtered_df = df[df['ã‚µã‚¤ã‚º'] == selected_size]
                        st.subheader(f"{selected_size}ã®å•†å“")
                        st.dataframe(filtered_df)
                    
                    # CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    csv = df.to_csv(index=False).encode('utf-8')
                    st.download_button(
                        label="CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=csv,
                        file_name=f"product_ids_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv"
                    )
                else:
                    st.error("å•†å“IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                logging.error(f"å•†å“IDå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}", exc_info=True)

    # å•†å“è©³ç´°å–å¾—
    st.header("å•†å“è©³ç´°å–å¾—")
    if st.button("é¸æŠã—ãŸã‚µã‚¤ã‚ºã®å•†å“è©³ç´°ã‚’ä¸€æ‹¬å–å¾—"):
        with st.spinner("å•†å“è©³ç´°ã‚’å–å¾—ä¸­..."):
            try:
                # é¸æŠã—ãŸã‚µã‚¤ã‚ºã®å•†å“IDã‚’å–å¾—
                product_ids = scraper.get_product_ids([selected_size])
                if not product_ids:
                    st.warning("å•†å“IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
                    st.stop()
                
                # é€²æ—ãƒãƒ¼ã®è¨­å®š
                progress_bar = st.progress(0)
                total_products = len(product_ids)
                
                # å•†å“è©³ç´°ã®å–å¾—
                all_data = []
                for i, product in enumerate(product_ids, 1):
                    try:
                        product_id = product['id']
                        data = scraper.get_product_data(product_id)
                        if data:
                            # å•†å“åãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åå‰ã‚’ä½¿ç”¨
                            if 'å•†å“å' not in data or not data['å•†å“å']:
                                data['å•†å“å'] = product.get('name', '')
                            all_data.append(data)
                        progress_bar.progress(i / total_products)
                    except Exception as e:
                        logging.error(f"å•†å“ {product.get('id', 'unknown')} ã®è©³ç´°å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}", exc_info=True)
                        continue
                
                if all_data:
                    st.success(f"{len(all_data)}ä»¶ã®å•†å“è©³ç´°ã‚’å–å¾—ã—ã¾ã—ãŸã€‚")
                    
                    # å•†å“è©³ç´°ã®è¡¨ç¤º
                    st.subheader("å–å¾—ã—ãŸå•†å“è©³ç´°")
                    df = pd.DataFrame(all_data)
                    st.dataframe(df)
            
                    # CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    csv = df.to_csv(index=False).encode('utf-8')
                    st.download_button(
                        label="CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=csv,
                        file_name=f"product_details_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                        mime="text/csv"
                    )
                else:
                    st.error("å•†å“è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                logging.error(f"å•†å“è©³ç´°å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}", exc_info=True)

if __name__ == "__main__":
    pass